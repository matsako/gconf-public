<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Island Survival üèùÔ∏è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        h1 {
            color: #fff;
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .controls-hint {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
        }

        canvas {
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }

        .inventory {
            display: flex;
            gap: 15px;
            background: rgba(0,0,0,0.6);
            padding: 12px 24px;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
        }

        .inventory-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .inventory-item .count {
            font-weight: bold;
            min-width: 20px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>üèùÔ∏è Island Survival</h1>
        <canvas id="game" width="800" height="600"></canvas>
        <div class="inventory" id="inventory">
            <div class="inventory-item">ü™µ <span class="count" id="inv-wood">0</span></div>
            <div class="inventory-item">ü™® <span class="count" id="inv-stone">0</span></div>
            <div class="inventory-item">ü•• <span class="count" id="inv-coconut">0</span></div>
            <div class="inventory-item">üåø <span class="count" id="inv-fiber">0</span></div>
        </div>
        <p class="controls-hint">WASD ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ | E ‚Äî —Å–æ–±—Ä–∞—Ç—å | B ‚Äî —Å—Ç—Ä–æ–∏—Ç—å</p>
    </div>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');

        // === –ù–ê–°–¢–†–û–ô–ö–ò –ò–ì–†–´ ===
        const TILE_SIZE = 64;
        const MAP_WIDTH = 20;
        const MAP_HEIGHT = 15;

        // === –ò–ì–†–û–ö ===
        const player = {
            x: 400,
            y: 300,
            width: 40,
            height: 40,
            speed: 4,
            // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –¥–ª—è –±—É–¥—É—â–µ–π –∞–Ω–∏–º–∞—Ü–∏–∏
            direction: 'down'
        };

        // === –û–ë–™–ï–ö–¢–´ –ù–ê –ö–ê–†–¢–ï ===
        const objects = [
            // –î–µ—Ä–µ–≤—å—è (–ø–∞–ª—å–º—ã)
            { x: 150, y: 120, type: 'palm', emoji: 'üå¥', width: 50, height: 60 },
            { x: 600, y: 100, type: 'palm', emoji: 'üå¥', width: 50, height: 60 },
            { x: 700, y: 350, type: 'palm', emoji: 'üå¥', width: 50, height: 60 },
            { x: 100, y: 400, type: 'palm', emoji: 'üå¥', width: 50, height: 60 },
            
            // –û–±—ã—á–Ω—ã–µ –¥–µ—Ä–µ–≤—å—è
            { x: 300, y: 80, type: 'tree', emoji: 'üå≥', width: 50, height: 60 },
            { x: 550, y: 450, type: 'tree', emoji: 'üå≥', width: 50, height: 60 },
            { x: 200, y: 500, type: 'tree', emoji: 'üå≥', width: 50, height: 60 },
            
            // –ö–∞–º–Ω–∏
            { x: 450, y: 200, type: 'rock', emoji: 'ü™®', width: 40, height: 40 },
            { x: 250, y: 350, type: 'rock', emoji: 'ü™®', width: 40, height: 40 },
            { x: 650, y: 500, type: 'rock', emoji: 'ü™®', width: 40, height: 40 },
            { x: 500, y: 400, type: 'rock', emoji: 'ü™®', width: 40, height: 40 },

            // –ö—É—Å—Ç—ã
            { x: 350, y: 150, type: 'bush', emoji: 'üåø', width: 35, height: 35 },
            { x: 180, y: 250, type: 'bush', emoji: 'üåø', width: 35, height: 35 },
            { x: 620, y: 280, type: 'bush', emoji: 'üåø', width: 35, height: 35 },

            // –¶–≤–µ—Ç—ã (–¥–µ–∫–æ—Ä)
            { x: 400, y: 500, type: 'flower', emoji: 'üå∫', width: 25, height: 25 },
            { x: 520, y: 150, type: 'flower', emoji: 'üå∏', width: 25, height: 25 },
            { x: 130, y: 320, type: 'flower', emoji: 'üåº', width: 25, height: 25 },
        ];

        // === –ò–ù–í–ï–ù–¢–ê–†–¨ ===
        const inventory = {
            wood: 0,
            stone: 0,
            coconut: 0,
            fiber: 0
        };

        // –ö–∞–∫–∏–µ —Ä–µ—Å—É—Ä—Å—ã –¥–∞—é—Ç –æ–±—ä–µ–∫—Ç—ã
        const resourceMap = {
            palm: { resource: 'coconut', amount: 2 },
            tree: { resource: 'wood', amount: 3 },
            rock: { resource: 'stone', amount: 2 },
            bush: { resource: 'fiber', amount: 1 }
        };

        // –û–±–Ω–æ–≤–ª—è–µ–º UI –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        function updateInventoryUI() {
            document.getElementById('inv-wood').textContent = inventory.wood;
            document.getElementById('inv-stone').textContent = inventory.stone;
            document.getElementById('inv-coconut').textContent = inventory.coconut;
            document.getElementById('inv-fiber').textContent = inventory.fiber;
        }

        // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π —Å–æ–±–∏—Ä–∞–µ–º—ã–π –æ–±—ä–µ–∫—Ç
        function findNearbyObject() {
            const playerCenterX = player.x + player.width / 2;
            const playerCenterY = player.y + player.height / 2;
            const interactionRadius = 60; // –†–∞–¥–∏—É—Å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

            let closest = null;
            let closestDist = Infinity;

            for (let i = 0; i < objects.length; i++) {
                const obj = objects[i];
                // –ú–æ–∂–Ω–æ —Å–æ–±–∏—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–µ—Ä–µ–≤—å—è, –ø–∞–ª—å–º—ã, –∫–∞–º–Ω–∏ –∏ –∫—É—Å—Ç—ã
                if (!resourceMap[obj.type]) continue;

                const objCenterX = obj.x + obj.width / 2;
                const objCenterY = obj.y + obj.height / 2;
                const dist = Math.sqrt(
                    Math.pow(playerCenterX - objCenterX, 2) + 
                    Math.pow(playerCenterY - objCenterY, 2)
                );

                if (dist < interactionRadius && dist < closestDist) {
                    closest = { obj, index: i };
                    closestDist = dist;
                }
            }

            return closest;
        }

        // –°–æ–±–∏—Ä–∞–µ–º —Ä–µ—Å—É—Ä—Å
        function collectResource() {
            const nearby = findNearbyObject();
            if (!nearby) return;

            const { obj, index } = nearby;
            const resourceInfo = resourceMap[obj.type];

            if (resourceInfo) {
                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ—Å—É—Ä—Å –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
                inventory[resourceInfo.resource] += resourceInfo.amount;
                updateInventoryUI();

                // –£–¥–∞–ª—è–µ–º –æ–±—ä–µ–∫—Ç —Å –∫–∞—Ä—Ç—ã
                objects.splice(index, 1);

                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–≤—É–∫ –∏–ª–∏ –∞–Ω–∏–º–∞—Ü–∏—é —Å–±–æ—Ä–∞
                showCollectEffect(obj);
            }
        }

        // –≠—Ñ—Ñ–µ–∫—Ç —Å–±–æ—Ä–∞ (–ø—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è)
        let collectEffects = [];
        function showCollectEffect(obj) {
            collectEffects.push({
                x: obj.x + obj.width / 2,
                y: obj.y,
                text: '+' + resourceMap[obj.type].amount,
                alpha: 1,
                offsetY: 0
            });
        }

        // === –°–¢–†–û–ò–¢–ï–õ–¨–°–¢–í–û ===
        let buildMode = false;

        // –†–µ—Ü–µ–ø—Ç—ã –ø–æ—Å—Ç—Ä–æ–µ–∫ (buildTime –≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
        const buildRecipes = [
            { 
                name: '–ö–æ—Å—Ç—ë—Ä', 
                emoji: 'üî•', 
                type: 'campfire',
                cost: { wood: 5, stone: 3 },
                buildTime: 5,  // 5 —Å–µ–∫—É–Ω–¥
                width: 40, 
                height: 40 
            },
            { 
                name: '–ü–∞–ª–∞—Ç–∫–∞', 
                emoji: '‚õ∫', 
                type: 'tent',
                cost: { wood: 8, fiber: 5 },
                buildTime: 15, // 15 —Å–µ–∫—É–Ω–¥
                width: 55, 
                height: 55 
            },
            { 
                name: '–î–æ–º–∏–∫', 
                emoji: 'üè†', 
                type: 'house',
                cost: { wood: 15, stone: 10 },
                buildTime: 30, // 30 —Å–µ–∫—É–Ω–¥
                width: 60, 
                height: 65 
            }
        ];

        // –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–æ–π–∫–∞ (–µ—Å–ª–∏ –∏–≥—Ä–æ–∫ —Å—Ç—Ä–æ–∏—Ç)
        let currentBuilding = null;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ö–≤–∞—Ç–∞–µ—Ç –ª–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
        function canBuild(recipe) {
            for (const [resource, amount] of Object.entries(recipe.cost)) {
                if (inventory[resource] < amount) return false;
            }
            return true;
        }

        // –°—Ç—Ä–æ–∏–º!
        function build(recipeIndex) {
            if (recipeIndex < 0 || recipeIndex >= buildRecipes.length) return;
            
            // –ù–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–æ–π–∫—É –ø–æ–∫–∞ –∏–¥—ë—Ç –¥—Ä—É–≥–∞—è
            if (currentBuilding) {
                showBuildError('–°–Ω–∞—á–∞–ª–∞ –¥–æ—Å—Ç—Ä–æ–π—Ç–µ —Ç–µ–∫—É—â–µ–µ!');
                return;
            }
            
            const recipe = buildRecipes[recipeIndex];
            
            if (!canBuild(recipe)) {
                showBuildError('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤!');
                return;
            }

            // –°–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã
            for (const [resource, amount] of Object.entries(recipe.cost)) {
                inventory[resource] -= amount;
            }
            updateInventoryUI();

            // –ù–∞—Ö–æ–¥–∏–º –º–µ—Å—Ç–æ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–π–∫–∏ (—Ä—è–¥–æ–º —Å –∏–≥—Ä–æ–∫–æ–º)
            const buildX = player.x + player.width + 20;
            const buildY = player.y;

            // –°–æ–∑–¥–∞—ë–º "—Å—Ç—Ä–æ—è—â–∏–π—Å—è" –æ–±—ä–µ–∫—Ç
            const newBuilding = {
                x: buildX,
                y: buildY,
                type: recipe.type,
                emoji: 'üöß',  // –°—Ç—Ä–æ–π–∫–∞ –ø–æ–∫–∞ –∏–¥—ë—Ç
                finalEmoji: recipe.emoji,
                name: recipe.name,
                width: recipe.width,
                height: recipe.height,
                isBuilding: true,
                buildProgress: 0,
                buildTime: recipe.buildTime,
                buildStartTime: Date.now()
            };

            objects.push(newBuilding);
            currentBuilding = newBuilding;

            buildMode = false;
        }

        let buildError = null;
        function showBuildError(msg) {
            buildError = { text: msg, alpha: 1 };
        }

        // === –£–ü–†–ê–í–õ–ï–ù–ò–ï ===
        const keys = {
            up: false,
            down: false,
            left: false,
            right: false
        };

        document.addEventListener('keydown', (e) => {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º e.code –¥–ª—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –∫–ª–∞–≤–∏—à (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–æ–π)
            switch(e.code) {
                case 'KeyW':
                case 'ArrowUp':
                    keys.up = true;
                    e.preventDefault();
                    break;
                case 'KeyS':
                case 'ArrowDown':
                    keys.down = true;
                    e.preventDefault();
                    break;
                case 'KeyA':
                case 'ArrowLeft':
                    keys.left = true;
                    e.preventDefault();
                    break;
                case 'KeyD':
                case 'ArrowRight':
                    keys.right = true;
                    e.preventDefault();
                    break;
                case 'KeyE':
                case 'Space':
                    if (!buildMode) {
                        collectResource();
                    }
                    e.preventDefault();
                    break;
                case 'KeyB':
                    buildMode = !buildMode;
                    e.preventDefault();
                    break;
                case 'Digit1':
                case 'Numpad1':
                    if (buildMode) build(0);
                    break;
                case 'Digit2':
                case 'Numpad2':
                    if (buildMode) build(1);
                    break;
                case 'Digit3':
                case 'Numpad3':
                    if (buildMode) build(2);
                    break;
                case 'Escape':
                    buildMode = false;
                    break;
            }
        });

        document.addEventListener('keyup', (e) => {
            switch(e.code) {
                case 'KeyW':
                case 'ArrowUp':
                    keys.up = false;
                    break;
                case 'KeyS':
                case 'ArrowDown':
                    keys.down = false;
                    break;
                case 'KeyA':
                case 'ArrowLeft':
                    keys.left = false;
                    break;
                case 'KeyD':
                case 'ArrowRight':
                    keys.right = false;
                    break;
            }
        });

        // === –ö–û–õ–õ–ò–ó–ò–ò ===
        function checkCollision(newX, newY) {
            const playerBox = {
                x: newX,
                y: newY,
                width: player.width,
                height: player.height
            };

            for (const obj of objects) {
                // –î–ª—è –¥–µ—Ä–µ–≤—å–µ–≤ –∫–æ–ª–ª–∏–∑–∏—è —Ç–æ–ª—å–∫–æ —Å "—Å—Ç–≤–æ–ª–æ–º" (–Ω–∏–∂–Ω—è—è —á–∞—Å—Ç—å)
                let objBox;
                if (obj.type === 'palm' || obj.type === 'tree') {
                    objBox = {
                        x: obj.x + 10,
                        y: obj.y + obj.height - 20,
                        width: obj.width - 20,
                        height: 20
                    };
                } else if (obj.type === 'rock') {
                    objBox = {
                        x: obj.x,
                        y: obj.y,
                        width: obj.width,
                        height: obj.height
                    };
                } else if (obj.isBuilding) {
                    // –ü–æ—Å—Ç—Ä–æ–π–∫–∏ ‚Äî –∫–æ–ª–ª–∏–∑–∏—è —Å –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç—å—é
                    objBox = {
                        x: obj.x,
                        y: obj.y + obj.height - 25,
                        width: obj.width,
                        height: 25
                    };
                } else {
                    // –¶–≤–µ—Ç—ã –∏ –∫—É—Å—Ç—ã ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å
                    continue;
                }

                if (playerBox.x < objBox.x + objBox.width &&
                    playerBox.x + playerBox.width > objBox.x &&
                    playerBox.y < objBox.y + objBox.height &&
                    playerBox.y + playerBox.height > objBox.y) {
                    return true;
                }
            }
            return false;
        }

        // === –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ì–†–´ ===
        function update() {
            let newX = player.x;
            let newY = player.y;

            if (keys.up) {
                newY -= player.speed;
                player.direction = 'up';
            }
            if (keys.down) {
                newY += player.speed;
                player.direction = 'down';
            }
            if (keys.left) {
                newX -= player.speed;
                player.direction = 'left';
            }
            if (keys.right) {
                newX += player.speed;
                player.direction = 'right';
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã
            newX = Math.max(0, Math.min(canvas.width - player.width, newX));
            newY = Math.max(0, Math.min(canvas.height - player.height, newY));

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–ª–∏–∑–∏–∏
            if (!checkCollision(newX, player.y)) {
                player.x = newX;
            }
            if (!checkCollision(player.x, newY)) {
                player.y = newY;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã —Å–±–æ—Ä–∞
            for (let i = collectEffects.length - 1; i >= 0; i--) {
                collectEffects[i].offsetY -= 1.5;
                collectEffects[i].alpha -= 0.02;
                if (collectEffects[i].alpha <= 0) {
                    collectEffects.splice(i, 1);
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
            if (currentBuilding) {
                const elapsed = (Date.now() - currentBuilding.buildStartTime) / 1000;
                currentBuilding.buildProgress = Math.min(elapsed / currentBuilding.buildTime, 1);
                
                // –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!
                if (currentBuilding.buildProgress >= 1) {
                    currentBuilding.emoji = currentBuilding.finalEmoji;
                    currentBuilding.buildProgress = undefined; // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                    
                    // –≠—Ñ—Ñ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                    collectEffects.push({
                        x: currentBuilding.x + currentBuilding.width / 2,
                        y: currentBuilding.y,
                        text: '‚úì ' + currentBuilding.name + ' –≥–æ—Ç–æ–≤!',
                        alpha: 1,
                        offsetY: 0
                    });
                    
                    currentBuilding = null;
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—à–∏–±–∫—É —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
            if (buildError) {
                buildError.alpha -= 0.02;
                if (buildError.alpha <= 0) {
                    buildError = null;
                }
            }
        }

        // === –û–¢–†–ò–°–û–í–ö–ê ===
        function draw() {
            // –§–æ–Ω ‚Äî —Ç—Ä–∞–≤–∞
            const gradient = ctx.createRadialGradient(400, 300, 0, 400, 300, 500);
            gradient.addColorStop(0, '#7ec850');
            gradient.addColorStop(1, '#5a9a38');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –¢–µ–∫—Å—Ç—É—Ä–∞ —Ç—Ä–∞–≤—ã (–ø—Ä–æ—Å—Ç—ã–µ —Ç–æ—á–∫–∏)
            ctx.fillStyle = 'rgba(90, 154, 56, 0.5)';
            for (let i = 0; i < 100; i++) {
                const x = (i * 73) % canvas.width;
                const y = (i * 47) % canvas.height;
                ctx.beginPath();
                ctx.arc(x, y, 2, 0, Math.PI * 2);
                ctx.fill();
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç—ã + –∏–≥—Ä–æ–∫–∞ –ø–æ Y –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (—á—Ç–æ –Ω–∏–∂–µ ‚Äî —Ä–∏—Å—É–µ—Ç—Å—è –ø–æ–∑–∂–µ)
            const allDrawable = [
                ...objects.map(obj => ({ ...obj, isPlayer: false })),
                { x: player.x, y: player.y + player.height, isPlayer: true }
            ];
            allDrawable.sort((a, b) => {
                const aY = a.isPlayer ? a.y : a.y + (a.height || 0);
                const bY = b.isPlayer ? b.y : b.y + (b.height || 0);
                return aY - bY;
            });

            // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π –æ–±—ä–µ–∫—Ç –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
            const nearbyObj = findNearbyObject();

            // –†–∏—Å—É–µ–º –≤—Å—ë
            for (const item of allDrawable) {
                if (item.isPlayer) {
                    drawPlayer();
                } else {
                    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –±–ª–∏–∂–∞–π—à–∏–π –æ–±—ä–µ–∫—Ç
                    const isHighlighted = nearbyObj && nearbyObj.obj === objects.find(o => 
                        o.x === item.x && o.y === item.y && o.type === item.type
                    );
                    drawObject(item, isHighlighted);
                }
            }

            // –†–∏—Å—É–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã —Å–±–æ—Ä–∞
            for (const effect of collectEffects) {
                ctx.globalAlpha = effect.alpha;
                ctx.fillStyle = '#FFD700';
                ctx.font = 'bold 24px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(effect.text, effect.x, effect.y + effect.offsetY);
                ctx.globalAlpha = 1;
            }

            // –ü–æ–¥—Å–∫–∞–∑–∫–∞ "–ù–∞–∂–º–∏ E" –µ—Å–ª–∏ —Ä—è–¥–æ–º –µ—Å—Ç—å –æ–±—ä–µ–∫—Ç
            if (nearbyObj && !buildMode) {
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                const hintX = nearbyObj.obj.x + nearbyObj.obj.width / 2;
                const hintY = nearbyObj.obj.y - 10;
                ctx.fillText('–ù–∞–∂–º–∏ E', hintX, hintY);
            }

            // –ú–µ–Ω—é —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
            if (buildMode) {
                drawBuildMenu();
            }

            // –û—à–∏–±–∫–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
            if (buildError) {
                ctx.globalAlpha = buildError.alpha;
                ctx.fillStyle = '#FF4444';
                ctx.font = 'bold 20px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(buildError.text, canvas.width / 2, 100);
                ctx.globalAlpha = 1;
            }

            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ (–≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞)
            if (currentBuilding && !buildMode) {
                const barWidth = 200;
                const barHeight = 20;
                const barX = canvas.width / 2 - barWidth / 2;
                const barY = 30;
                
                // –§–æ–Ω
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.beginPath();
                ctx.roundRect(barX - 10, barY - 25, barWidth + 20, barHeight + 35, 8);
                ctx.fill();
                
                // –¢–µ–∫—Å—Ç
                ctx.fillStyle = '#FFF';
                ctx.font = 'bold 14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`üî® –°—Ç—Ä–æ–∏—Ç—Å—è: ${currentBuilding.name}`, canvas.width / 2, barY - 5);
                
                // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                ctx.fillStyle = '#333';
                ctx.beginPath();
                ctx.roundRect(barX, barY, barWidth, barHeight, 5);
                ctx.fill();
                
                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
                ctx.fillStyle = '#4CAF50';
                ctx.beginPath();
                ctx.roundRect(barX + 2, barY + 2, (barWidth - 4) * currentBuilding.buildProgress, barHeight - 4, 3);
                ctx.fill();
                
                // –ü—Ä–æ—Ü–µ–Ω—Ç
                const percent = Math.floor(currentBuilding.buildProgress * 100);
                ctx.fillStyle = '#FFF';
                ctx.font = 'bold 12px sans-serif';
                ctx.fillText(`${percent}%`, canvas.width / 2, barY + 15);
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–µ–Ω—é —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
        function drawBuildMenu() {
            // –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞
            ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            ctx.fillStyle = '#FFF';
            ctx.font = 'bold 28px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('üî® –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ', canvas.width / 2, 80);
            ctx.font = '16px sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            ctx.fillText('–ù–∞–∂–º–∏ 1, 2 –∏–ª–∏ 3 –¥–ª—è –ø–æ—Å—Ç—Ä–æ–π–∫–∏ | ESC ‚Äî –∑–∞–∫—Ä—ã—Ç—å', canvas.width / 2, 110);

            // –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–æ—Å—Ç—Ä–æ–µ–∫
            const cardWidth = 180;
            const cardHeight = 175;
            const startX = canvas.width / 2 - (cardWidth * 3 + 40) / 2;
            const cardY = 150;

            buildRecipes.forEach((recipe, index) => {
                const cardX = startX + index * (cardWidth + 20);
                const available = canBuild(recipe);

                // –§–æ–Ω –∫–∞—Ä—Ç–æ—á–∫–∏
                ctx.fillStyle = available ? 'rgba(80, 180, 80, 0.9)' : 'rgba(100, 100, 100, 0.9)';
                ctx.beginPath();
                ctx.roundRect(cardX, cardY, cardWidth, cardHeight, 12);
                ctx.fill();

                // –û–±–≤–æ–¥–∫–∞
                ctx.strokeStyle = available ? '#4CAF50' : '#666';
                ctx.lineWidth = 3;
                ctx.stroke();

                // –ù–æ–º–µ—Ä
                ctx.fillStyle = '#FFF';
                ctx.font = 'bold 24px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`${index + 1}`, cardX + cardWidth / 2, cardY + 30);

                // –≠–º–æ–¥–∑–∏
                ctx.font = '50px serif';
                ctx.fillText(recipe.emoji, cardX + cardWidth / 2, cardY + 85);

                // –ù–∞–∑–≤–∞–Ω–∏–µ
                ctx.fillStyle = '#FFF';
                ctx.font = 'bold 16px sans-serif';
                ctx.fillText(recipe.name, cardX + cardWidth / 2, cardY + 115);

                // –°—Ç–æ–∏–º–æ—Å—Ç—å
                ctx.font = '14px sans-serif';
                let costText = '';
                for (const [res, amt] of Object.entries(recipe.cost)) {
                    const emoji = res === 'wood' ? 'ü™µ' : res === 'stone' ? 'ü™®' : res === 'fiber' ? 'üåø' : 'ü••';
                    costText += `${emoji}${amt} `;
                }
                ctx.fillText(costText, cardX + cardWidth / 2, cardY + 138);
                
                // –í—Ä–µ–º—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
                ctx.fillStyle = 'rgba(255,255,255,0.8)';
                ctx.font = '12px sans-serif';
                ctx.fillText(`‚è±Ô∏è ${recipe.buildTime} —Å–µ–∫`, cardX + cardWidth / 2, cardY + 155);
            });
        }

        function drawObject(obj, isHighlighted = false) {
            const cx = obj.x + obj.width / 2;
            const cy = obj.y + obj.height;

            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';

            // –¶–≤–µ—Ç–Ω–æ–π —Ñ–æ–Ω –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ–±—ä–µ–∫—Ç–∞
            let bgColor;
            switch(obj.type) {
                case 'palm':
                case 'tree':
                    bgColor = '#8B5A2B'; // –ö–æ—Ä–∏—á–Ω–µ–≤—ã–π –¥–ª—è –¥–µ—Ä–µ–≤—å–µ–≤
                    break;
                case 'rock':
                    bgColor = '#696969'; // –°–µ—Ä—ã–π –¥–ª—è –∫–∞–º–Ω–µ–π
                    break;
                case 'bush':
                    bgColor = '#228B22'; // –ó–µ–ª—ë–Ω—ã–π –¥–ª—è –∫—É—Å—Ç–æ–≤
                    break;
                case 'flower':
                    bgColor = '#FFB6C1'; // –†–æ–∑–æ–≤—ã–π –¥–ª—è —Ü–≤–µ—Ç–æ–≤
                    break;
                default:
                    bgColor = '#DEB887'; // –ë–µ–∂–µ–≤—ã–π –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–∫
            }
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –µ—Å–ª–∏ —Ä—è–¥–æ–º (–¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è)
            if (isHighlighted) {
                ctx.fillStyle = 'rgba(255, 255, 100, 0.7)';
                ctx.beginPath();
                ctx.ellipse(cx, cy - 5, obj.width/2 + 18, obj.height/2 + 10, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // –Ø—Ä–∫–∞—è –æ–±–≤–æ–¥–∫–∞
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 4;
                ctx.stroke();
            }

            // –Ø—Ä–∫–∏–π —Ü–≤–µ—Ç–Ω–æ–π –∫—Ä—É–≥-–æ—Å–Ω–æ–≤–∞ –ø–æ–¥ –æ–±—ä–µ–∫—Ç–æ–º
            ctx.fillStyle = bgColor;
            ctx.beginPath();
            ctx.ellipse(cx, cy - obj.height/3, obj.width/2 + 8, obj.height/2 + 5, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // –°–≤–µ—Ç–ª–∞—è –æ–±–≤–æ–¥–∫–∞ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.lineWidth = 3;
            ctx.stroke();

            // –¢–µ–Ω—å –ø–æ–¥ –æ–±—ä–µ–∫—Ç–æ–º
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.beginPath();
            ctx.ellipse(cx, cy + 2, obj.width/2.5, 12, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // –°–∞–º –æ–±—ä–µ–∫—Ç (—ç–º–æ–¥–∑–∏)
            ctx.font = `${obj.height + 10}px serif`;
            ctx.fillText(obj.emoji, cx, cy + 6);

            // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è —Å—Ç—Ä–æ—è—â–∏—Ö—Å—è –æ–±—ä–µ–∫—Ç–æ–≤
            if (obj.isBuilding && obj.buildProgress !== undefined && obj.buildProgress < 1) {
                const barWidth = obj.width + 20;
                const barHeight = 8;
                const barX = cx - barWidth / 2;
                const barY = obj.y - 20;
                
                // –§–æ–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.beginPath();
                ctx.roundRect(barX, barY, barWidth, barHeight, 4);
                ctx.fill();
                
                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
                ctx.fillStyle = '#4CAF50';
                ctx.beginPath();
                ctx.roundRect(barX + 2, barY + 2, (barWidth - 4) * obj.buildProgress, barHeight - 4, 2);
                ctx.fill();
                
                // –¢–µ–∫—Å—Ç
                ctx.fillStyle = '#FFF';
                ctx.font = 'bold 12px sans-serif';
                ctx.fillText('–°—Ç—Ä–æ–∏—Ç—Å—è...', cx, barY - 5);
            }
        }

        function drawPlayer() {
            const cx = player.x + player.width / 2;
            const cy = player.y + player.height;

            // –¢–µ–Ω—å –ø–æ–¥ –∏–≥—Ä–æ–∫–æ–º
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.beginPath();
            ctx.ellipse(cx, cy, 16, 6, 0, 0, Math.PI * 2);
            ctx.fill();

            // === –†–ò–°–£–ï–ú –ü–ï–†–°–û–ù–ê–ñ–ê ===
            // –¶–≤–µ—Ç–∞
            const skinColor = '#FFD5B8';
            const hairColor = '#5D4037';
            const shirtColor = '#E53935';  // –Ø—Ä–∫–∏–π –∫—Ä–∞—Å–Ω—ã–π
            const pantsColor = '#1565C0';  // –°–∏–Ω–∏–π
            const outlineColor = '#2D2D2D';
            const outlineWidth = 2;

            // –ù–æ–≥–∏ (–¥–≤–∞ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞)
            ctx.fillStyle = pantsColor;
            ctx.strokeStyle = outlineColor;
            ctx.lineWidth = outlineWidth;
            
            // –õ–µ–≤–∞—è –Ω–æ–≥–∞
            ctx.beginPath();
            ctx.roundRect(cx - 10, cy - 18, 8, 16, 2);
            ctx.fill();
            ctx.stroke();
            
            // –ü—Ä–∞–≤–∞—è –Ω–æ–≥–∞
            ctx.beginPath();
            ctx.roundRect(cx + 2, cy - 18, 8, 16, 2);
            ctx.fill();
            ctx.stroke();

            // –¢–µ–ª–æ (–ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ —Å –∑–∞–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º)
            ctx.fillStyle = shirtColor;
            ctx.beginPath();
            ctx.roundRect(cx - 12, cy - 38, 24, 22, 4);
            ctx.fill();
            ctx.stroke();

            // –†—É–∫–∏
            ctx.fillStyle = skinColor;
            // –õ–µ–≤–∞—è —Ä—É–∫–∞
            ctx.beginPath();
            ctx.roundRect(cx - 18, cy - 35, 7, 16, 3);
            ctx.fill();
            ctx.stroke();
            
            // –ü—Ä–∞–≤–∞—è —Ä—É–∫–∞
            ctx.beginPath();
            ctx.roundRect(cx + 11, cy - 35, 7, 16, 3);
            ctx.fill();
            ctx.stroke();

            // –ì–æ–ª–æ–≤–∞ (–∫—Ä—É–≥)
            ctx.fillStyle = skinColor;
            ctx.beginPath();
            ctx.arc(cx, cy - 48, 14, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // –í–æ–ª–æ—Å—ã (–ø–æ–ª—É–∫—Ä—É–≥ —Å–≤–µ—Ä—Ö—É)
            ctx.fillStyle = hairColor;
            ctx.beginPath();
            ctx.arc(cx, cy - 50, 12, Math.PI, 0);
            ctx.fill();

            // –ì–ª–∞–∑–∞
            ctx.fillStyle = '#2D2D2D';
            ctx.beginPath();
            ctx.arc(cx - 5, cy - 50, 2, 0, Math.PI * 2);
            ctx.arc(cx + 5, cy - 50, 2, 0, Math.PI * 2);
            ctx.fill();

            // –†—É–º—è–Ω–µ—Ü (—â—ë—á–∫–∏)
            ctx.fillStyle = 'rgba(255, 150, 150, 0.5)';
            ctx.beginPath();
            ctx.ellipse(cx - 9, cy - 46, 3, 2, 0, 0, Math.PI * 2);
            ctx.ellipse(cx + 9, cy - 46, 3, 2, 0, 0, Math.PI * 2);
            ctx.fill();
        }

        // === –ò–ì–†–û–í–û–ô –¶–ò–ö–õ ===
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // –°—Ç–∞—Ä—Ç—É–µ–º!
        gameLoop();
    </script>
</body>
</html>
